{% extends "base.html" %}

{% block title %}Employees - Zahoree Staffing Hub{% endblock %}

{% block content %}

<div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
    <!-- Filtros: status, account, buscar -->
    <form method="get" action="{{ url_for('list_employees') }}" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; width:100%;">
        <div>
            <label for="status">Estatus</label><br>
            <select name="status" id="status" style="padding:6px;">
                <option value="Active" {% if current_status == 'Active' %}selected{% endif %}>Active</option>
                <option value="Inactive" {% if current_status == 'Inactive' %}selected{% endif %}>Inactive</option>
            </select>
        </div>

        <div>
            <label for="account">Cuenta</label><br>
            <select name="account" id="account" style="padding:6px;">
                <option value="" {% if not current_account %}selected{% endif %}>Todas</option>
                {% for acc in accounts %}
                <option value="{{ acc }}" {% if acc == current_account %}selected{% endif %}>{{ acc }}</option>
                {% endfor %}
            </select>
        </div>

        <div style="flex:1; min-width:220px;">
            <label for="q">Nombre Completo</label><br>
            <input
                id="q"
                name="q"
                list="nameSuggestions"
                value="{{ current_query }}"
                placeholder="Buscar por nombre..."
                style="width:100%; padding:6px;"
                oninput="debouncedSuggest(this.value)"
            />
            <datalist id="nameSuggestions"></datalist>
        </div>

        <div>
            <button type="submit" style="padding:8px 12px;">Aplicar</button>
            <a href="{{ url_for('list_employees') }}" style="padding:8px 12px; display:inline-block; text-decoration:none; border:1px solid #ccc; border-radius:4px; margin-left:6px;">Limpiar</a>
        </div>
    </form>
</div>

{% if employees %}
<div style="overflow-x: auto;">

    <table border="1" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th>ID</th>
                <th>Nombre Completo</th>
                <th>Cuenta</th>
                <th>Posición</th>
                <th>Estatus</th>
                <th>Fecha Admisión</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody>
            {% for employee in employees %}
            <tr>
                <td>{{ employee.Employee_ID }}</td>
                <td>{{ employee["FULL NAME"] }}</td>
                <td>{{ employee.ACCOUNT }}</td>
                <td>{{ employee.POSITION }}</td>
                <td>{{ employee.STATUS }}</td>
                <td>{{ employee["DATE OF ADMITION"] }}</td>
                <td>
                    <button onclick="openEditModal('{{ employee.Employee_ID }}')">Editar (Modal)</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<p>No se encontraron empleados en la base de datos **Infolink_Staff**.</p>
{% endif %}

<!-- Paginacion de la tabla -->
<div style="margin: 24px 0 40px; display:flex; justify-content:center; align-items:center; gap:8px; flex-wrap:wrap;">
    {% if current_page > 1 %}
    <a href="{{ url_for('list_employees', page=current_page - 1) }}"
        style="text-decoration: none; padding: 5px 10px; border: 1px solid #333;">&laquo; Anterior</a>
    {% else %}
    <span style="padding: 5px 10px; border: 1px solid #ccc; color: #aaa;">&laquo; Anterior</span>
    {% endif %}

    {% for p in range(1, total_pages + 1) %}
    {% if p == current_page %}
    <span style="padding: 5px 10px; background-color: #333; color: white;">{{ p }}</span>
    {% elif p >= current_page - 2 and p <= current_page + 2 %} <a href="{{ url_for('list_employees', page=p) }}"
        style="text-decoration: none; padding: 5px 10px; border: 1px solid blue;">{{ p }}</a>
        {% elif loop.index == 1 or loop.index == total_pages %}
        <a href="{{ url_for('list_employees', page=p) }}"
            style="text-decoration: none; padding: 5px 10px; border: 1px solid blue;">{{ p }}</a>
        {% elif p == current_page - 3 or p == current_page + 3 %}
        <span>...</span>
        {% endif %}
        {% endfor %}

        {% if current_page < total_pages %} <a href="{{ url_for('list_employees', page=current_page + 1) }}"
            style="text-decoration: none; padding: 5px 10px; border: 1px solid #333;">Siguiente &raquo;</a>
            {% else %}
            <span style="padding: 5px 10px; border: 1px solid #ccc; color: #aaa;">Siguiente &raquo;</span>
            {% endif %}
</div>

<div id="editModal" style="display:none; /* Aquí irá la lógica de CSS y JS para el modal */">
    <h3>Editar Empleado</h3>
    <p>Pendiente: Aquí se cargará el formulario de edición.</p>
    <button onclick="document.getElementById('editModal').style.display='none'">Cerrar</button>
</div>

<script>
    function openEditModal(employeeId) {
        alert('Abriendo modal para editar ID: ' + employeeId);
        document.getElementById('editModal').style.display = 'block';
    }

    // Debounce helper
    let suggestTimer = null;
    function debouncedSuggest(val) {
        if (suggestTimer) clearTimeout(suggestTimer);
        suggestTimer = setTimeout(()=> { doSuggest(val); }, 250);
    }

    async function doSuggest(q) {
        const datalist = document.getElementById('nameSuggestions');
        datalist.innerHTML = '';
        if (!q || q.length < 1) return;
        try {
            const res = await fetch(`{{ url_for('employees_suggest') }}?q=${encodeURIComponent(q)}`);
            if (!res.ok) return;
            const names = await res.json();
            names.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n;
                datalist.appendChild(opt);
            });
        } catch (e) {
            console.error('Error fetching suggestions:', e);            
        }
    }
</script>

{% endblock content %}